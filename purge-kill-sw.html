<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíÄ PURGE KILL-SW.JS - √âlimination D√©finitive</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(135deg, #991b1b, #7f1d1d);
            color: white;
            text-align: center;
            border-radius: 20px;
        }
        .alert {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            font-weight: bold;
        }
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 13px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }
        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .btn:hover { 
            background: #991b1b; 
            transform: translateY(-2px);
        }
        .btn-success { 
            background: #059669; 
        }
        .btn-success:hover { 
            background: #047857; 
        }
        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #10b981;
            height: 100%;
            border-radius: 20px;
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <h1>üíÄ PURGE KILL-SW.JS</h1>
    <p><strong>√âlimination d√©finitive du Service Worker fant√¥me</strong></p>
    
    <div class="alert">
        üö® <strong>PROBL√àME D√âTECT√â</strong><br>
        Le fichier <code>kill-sw.js</code> est encore en cache navigateur<br>
        Cette page va l'√©liminer D√âFINITIVEMENT
    </div>
    
    <div class="progress">
        <div id="progress-bar" class="progress-bar"></div>
    </div>
    
    <div id="status" class="status">
        üíÄ Initialisation de la purge kill-sw.js...<br>
    </div>
    
    <button class="btn" onclick="startPurge()">
        üî• PURGER KILL-SW.JS MAINTENANT
    </button>
    
    <button class="btn btn-success" onclick="checkIfPurged()">
        ‚úÖ V√âRIFIER SI PURG√â
    </button>
    
    <button class="btn" onclick="nuclearReset()">
        ‚ò¢Ô∏è RESET NUCL√âAIRE TOTAL
    </button>

    <script>
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        let progress = 0;
        
        function log(message) {
            const time = new Date().toLocaleTimeString();
            status.innerHTML += `[${time}] ${message}<br>`;
            status.scrollTop = status.scrollHeight;
            console.log(message);
        }
        
        function updateProgress(percent) {
            progress = Math.min(100, percent);
            progressBar.style.width = progress + '%';
        }
        
        async function startPurge() {
            log('üö® D√âMARRAGE PURGE KILL-SW.JS');
            updateProgress(10);
            
            try {
                // 1. V√©rification pr√©sence kill-sw.js
                const registrations = await navigator.serviceWorker.getRegistrations();
                const killSW = registrations.find(reg => 
                    reg.scope.includes('kill-sw') || 
                    reg.active?.scriptURL?.includes('kill-sw')
                );
                
                if (killSW) {
                    log('üéØ KILL-SW.JS D√âTECT√â - √âlimination en cours...');
                } else {
                    log('üîç Aucun kill-sw.js visible - Purge pr√©ventive...');
                }
                updateProgress(25);
                
                // 2. D√©senregistrement FORC√â de TOUS les SW
                log('üí• D√©senregistrement forc√© de tous les Service Workers');
                for (const registration of registrations) {
                    log(`üóëÔ∏è Suppression forc√©e: ${registration.scope}`);
                    await registration.unregister();
                }
                updateProgress(50);
                
                // 3. Enregistrement temporaire du purificateur
                log('üßπ Enregistrement purificateur temporaire...');
                const purgeReg = await navigator.serviceWorker.register('/purge-cache.js', {
                    scope: '/',
                    updateViaCache: 'none' // Force pas de cache
                });
                updateProgress(65);
                
                // 4. √âcoute des messages du purificateur
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'CACHE_PURGED') {
                        log('‚úÖ Cache purg√© par le purificateur');
                        updateProgress(85);
                        
                        // Attendre puis v√©rifier
                        setTimeout(async () => {
                            const finalCheck = await navigator.serviceWorker.getRegistrations();
                            if (finalCheck.length === 0) {
                                log('üéâ SUCCESS ! Plus aucun Service Worker actif');
                                log('üíÄ kill-sw.js D√âFINITIVEMENT √âLIMIN√â !');
                                updateProgress(100);
                                alert('‚úÖ PURGE R√âUSSIE ! kill-sw.js √©limin√© d√©finitivement.');
                            } else {
                                log(`‚ö†Ô∏è ${finalCheck.length} SW encore pr√©sents`);
                                updateProgress(90);
                            }
                        }, 2000);
                    }
                });
                
                // 5. Attendre activation du purificateur
                await new Promise((resolve) => {
                    if (purgeReg.active) {
                        resolve();
                    } else {
                        purgeReg.addEventListener('updatefound', () => {
                            const worker = purgeReg.installing;
                            worker.addEventListener('statechange', () => {
                                if (worker.state === 'activated') {
                                    resolve();
                                }
                            });
                        });
                    }
                });
                
                log('‚ö° Purificateur actif - Nettoyage en cours...');
                updateProgress(75);
                
            } catch (error) {
                log(`üí• ERREUR PURGE: ${error.message}`);
                alert('‚ùå Erreur durant la purge. Essayez le reset nucl√©aire.');
            }
        }
        
        async function checkIfPurged() {
            log('üîç V√âRIFICATION PURGE');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                const cacheNames = await caches.keys();
                
                log(`üìä Service Workers actifs: ${registrations.length}`);
                log(`üìä Caches pr√©sents: ${cacheNames.length}`);
                
                const hasKillSW = registrations.some(reg => 
                    reg.scope.includes('kill-sw') || 
                    reg.active?.scriptURL?.includes('kill-sw')
                );
                
                if (hasKillSW) {
                    log('‚ùå KILL-SW.JS ENCORE PR√âSENT !');
                    alert('‚ùå kill-sw.js encore actif. Utilisez le reset nucl√©aire.');
                } else if (registrations.length === 0) {
                    log('‚úÖ PURGE R√âUSSIE - Plus aucun Service Worker');
                    updateProgress(100);
                    alert('‚úÖ SUCC√àS ! Aucun Service Worker actif.');
                } else {
                    log('‚ö†Ô∏è Autres Service Workers pr√©sents mais pas kill-sw.js');
                    registrations.forEach((reg, i) => {
                        log(`  SW ${i+1}: ${reg.scope}`);
                    });
                }
                
            } catch (error) {
                log(`üí• ERREUR V√âRIFICATION: ${error.message}`);
            }
        }
        
        async function nuclearReset() {
            if (!confirm('‚ò¢Ô∏è ATTENTION ! Reset nucl√©aire va tout supprimer. Continuer ?')) {
                return;
            }
            
            log('‚ò¢Ô∏è RESET NUCL√âAIRE ACTIV√â');
            updateProgress(0);
            
            try {
                // Suppression ultra-agressive
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(registrations.map(reg => {
                    log(`üíÄ Destruction nucl√©aire: ${reg.scope}`);
                    return reg.unregister();
                }));
                
                // Suppression caches
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => {
                    log(`üóëÔ∏è Cache vaporis√©: ${name}`);
                    return caches.delete(name);
                }));
                
                // Suppression storage
                localStorage.clear();
                sessionStorage.clear();
                
                updateProgress(100);
                log('‚ò¢Ô∏è RESET NUCL√âAIRE TERMIN√â');
                alert('‚ò¢Ô∏è Reset nucl√©aire termin√© ! Red√©marrez le navigateur.');
                
            } catch (error) {
                log(`üí• ERREUR NUCL√âAIRE: ${error.message}`);
            }
        }
        
        // Auto-v√©rification au chargement
        window.addEventListener('load', () => {
            setTimeout(checkIfPurged, 1000);
        });
    </script>
</body>
</html>
